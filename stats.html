<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إحصائيات حاسبة مكافأة نهاية الخدمة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Icons (اختياري) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            /* ألوان قريبة من SEEC */
            --seec-green: #0b5d3b;
            --seec-green-soft: #e5f4ee;
            --seec-gold: #c9a646;
            --seec-gray: #f5f5f5;
        }

        body {
            background-color: #f8faf9;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .navbar {
            background: linear-gradient(90deg, var(--seec-green) 0%, #107452 100%);
        }

        .navbar-brand, .navbar-nav .nav-link {
            color: #fff !important;
        }

        .page-header {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .page-header h1 {
            font-size: 1.8rem;
            color: var(--seec-green);
            font-weight: 700;
        }

        .metric-card {
            background-color: #ffffff;
            border-radius: 16px;
            border: 1px solid #dde5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            padding: 1.2rem 1.4rem;
            height: 100%;
        }

        .metric-label {
            font-size: 0.95rem;
            color: #687578;
        }

        .metric-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--seec-green);
        }

        .metric-sub {
            font-size: 0.8rem;
            color: #9aa3a6;
        }

        .badge-soft {
            background-color: var(--seec-green-soft);
            color: var(--seec-green);
            border-radius: 999px;
            padding: 0.25rem 0.7rem;
            font-size: 0.75rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--seec-green);
            margin-bottom: 0.75rem;
        }

        .table thead {
            background-color: var(--seec-green-soft);
        }

        .table thead th {
            color: var(--seec-green);
            font-weight: 600;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.8rem;
            background-color: #f0f0f0;
        }

        .chip-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .btn-seec {
            background-color: var(--seec-green);
            color: #fff;
            border-radius: 999px;
            border: none;
        }

        .btn-seec:hover {
            background-color: #07432a;
            color: #fff;
        }

        .btn-outline-seec {
            border-radius: 999px;
            border: 1px solid var(--seec-green);
            color: var(--seec-green);
            background-color: #fff;
        }

        .btn-outline-seec:hover {
            background-color: var(--seec-green-soft);
            color: var(--seec-green);
        }

        .empty-state {
            padding: 2rem 1rem;
            text-align: center;
            color: #8a9497;
        }
    </style>
</head>
<body>

<!-- شريط علوي -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">
            حاسبة مكافأة نهاية الخدمة – كفاءات عبدالعزيز
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">الحاسبة</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">عن الأداة</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active fw-semibold" aria-current="page" href="stats.html">الإحصائيات</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="feedback.html">التقييمات</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- المحتوى -->
<div class="container my-4">

    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h1>لوحة إحصائيات حاسبة مكافأة نهاية الخدمة</h1>
            <p class="text-muted mb-0">
                تعتمد هذه الإحصائيات على العمليات المحفوظة في المتصفح عبر
                <span class="badge-soft">LocalStorage – مفتاح: <code>kafaatazizHistory</code></span>
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-seec" id="btn-refresh">
                <i class="fa-solid fa-rotate"></i>
                تحديث البيانات
            </button>
            <button class="btn btn-seec" onclick="window.print()">
                <i class="fa-solid fa-print"></i>
                طباعة التقرير
            </button>
        </div>
    </div>

    <!-- ملخص سريع -->
    <section class="mb-4">
        <div class="row g-3">
            <div class="col-md-3 col-sm-6">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="metric-label">عدد العمليات المحفوظة</span>
                        <i class="fa-solid fa-database text-secondary"></i>
                    </div>
                    <div class="metric-value" id="total-operations">0</div>
                    <div class="metric-sub">كل عملية تم حفظها من صفحة الحاسبة</div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="metric-label">مجموع مكافآت نهاية الخدمة</span>
                        <i class="fa-solid fa-sack-dollar text-secondary"></i>
                    </div>
                    <div class="metric-value" id="total-rewards">0</div>
                    <div class="metric-sub">إجمالي المبالغ (ريال سعودي)</div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="metric-label">متوسط مدة الخدمة</span>
                        <i class="fa-solid fa-clock-rotate-left text-secondary"></i>
                    </div>
                    <div class="metric-value" id="avg-service-years">0</div>
                    <div class="metric-sub">بالسنوات عبر جميع العمليات</div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="metric-label">أعلى أجر شهري مسجّل</span>
                        <i class="fa-solid fa-arrow-trend-up text-secondary"></i>
                    </div>
                    <div class="metric-value" id="max-salary">0</div>
                    <div class="metric-sub">يشمل الراتب الأساسي والبدلات إن وُجدت</div>
                </div>
            </div>
        </div>
    </section>

    <!-- في حال لا توجد بيانات -->
    <section id="empty-state" class="empty-state d-none">
        <i class="fa-regular fa-face-smile-beam fa-2x mb-2"></i>
        <p class="mb-1">لا توجد حتى الآن أي عمليات محفوظة في المتصفح.</p>
        <p class="mb-0">
            جرّب الذهاب إلى صفحة <a href="index.html">الحاسبة</a> وإدخال بيانات ثم الضغط على
            <strong>"احسب واحفظ العملية"</strong>، وبعدها ارجع لهذه الصفحة.
        </p>
    </section>

    <div id="stats-content" class="d-none">

        <!-- إحصائيات حسب نوع الموظف + حسب جهة العمل -->
        <section class="mb-4">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="metric-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="section-title mb-0">إحصائية حسب جنسية الموظف</span>
                            <span class="badge-soft"><i class="fa-solid fa-user"></i> جنسية الموظف</span>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-sm-6">
                                <canvas id="employeeTypeChart" height="180"></canvas>
                            </div>
                            <div class="col-sm-6">
                                <table class="table table-sm mb-0">
                                    <thead>
                                    <tr>
                                        <th>النوع</th>
                                        <th class="text-center">العدد</th>
                                        <th class="text-center">النسبة %</th>
                                    </tr>
                                    </thead>
                                    <tbody id="employee-type-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="metric-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="section-title mb-0">إحصائية حسب جهة العمل</span>
                            <span class="badge-soft"><i class="fa-solid fa-building"></i> أعلى الجهات تكرارًا</span>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-sm-6">
                                <canvas id="employerChart" height="180"></canvas>
                            </div>
                            <div class="col-sm-6">
                                <table class="table table-sm mb-0">
                                    <thead>
                                    <tr>
                                        <th>جهة العمل</th>
                                        <th class="text-center">عدد العمليات</th>
                                    </tr>
                                    </thead>
                                    <tbody id="employer-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- جدول آخر العمليات -->
        <section class="mb-5">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="section-title mb-0">أحدث العمليات المحفوظة</span>
                    <span class="badge-soft"><i class="fa-solid fa-list-check"></i> آخر 10 عمليات</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم الموظف</th>
                            <th>جهة العمل</th>
                            <th>الجنسية</th>
                            <th>نوع العقد</th>
                            <th>مدة الخدمة (سنة)</th>
                            <th>الأجر الشهري</th>
                            <th>الأجر بعد التأمينات</th>
                            <th>مكافأة نهاية الخدمة</th>
                            <th>تاريخ الحساب</th>
                        </tr>
                        </thead>
                        <tbody id="history-table"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const HISTORY_KEY = 'kafaatazizHistory';

    function toNumber(value) {
        const n = Number(value);
        return isNaN(n) ? 0 : n;
    }

    function formatCurrency(num) {
        return num.toLocaleString('ar-SA', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        }) + ' ر.س';
    }

    function formatNumber(num) {
        return num.toLocaleString('ar-SA', {
            maximumFractionDigits: 2
        });
    }

    function formatDate(value) {
        if (!value) return '-';
        const d = new Date(value);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleString('ar-SA');
    }

    function loadHistory() {
        try {
            const raw = localStorage.getItem(HISTORY_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error('خطأ في قراءة LocalStorage:', e);
            return [];
        }
    }

    function buildStats() {
        const history = loadHistory();
        const emptyState = document.getElementById('empty-state');
        const statsContent = document.getElementById('stats-content');

        if (!history.length) {
            emptyState.classList.remove('d-none');
            statsContent.classList.add('d-none');
            document.getElementById('total-operations').textContent = '0';
            document.getElementById('total-rewards').textContent = '0';
            document.getElementById('avg-service-years').textContent = '0';
            document.getElementById('max-salary').textContent = '0';
            return;
        }

        emptyState.classList.add('d-none');
        statsContent.classList.remove('d-none');

        // 1) أرقام الملخص
        const totalOperations = history.length;

        const totalRewards = history.reduce((sum, r) => {
            // غيّر اسم الخاصية إذا كنت تستخدم اسم مختلف في index.html
            const reward =
                toNumber(r.endOfServiceReward) ||
                toNumber(r.totalReward) ||
                toNumber(r.totalBenefits);
            return sum + reward;
        }, 0);

        const totalServiceYears = history.reduce((sum, r) => {
            const years =
                toNumber(r.serviceYears) ||
                toNumber(r.yearsOfService);
            return sum + years;
        }, 0);

        const avgServiceYears = totalOperations ? (totalServiceYears / totalOperations) : 0;

        let maxSalary = 0;
        history.forEach(r => {
            const basic = toNumber(r.basicSalary);
            const allowances = toNumber(r.allowances);
            const totalSalary =
                toNumber(r.totalMonthlySalary) ||
                toNumber(r.monthlySalary) ||
                (basic + allowances);
            if (totalSalary > maxSalary) maxSalary = totalSalary;
        });

        document.getElementById('total-operations').textContent = formatNumber(totalOperations);
        document.getElementById('total-rewards').textContent = formatCurrency(totalRewards);
        document.getElementById('avg-service-years').textContent = formatNumber(avgServiceYears);
        document.getElementById('max-salary').textContent = formatCurrency(maxSalary);

        // 2) إحصائيات حسب نوع الموظف
        const employeeTypeCounts = {};
        history.forEach(r => {
            const type = r.employeeType || 'غير محدد';
            employeeTypeCounts[type] = (employeeTypeCounts[type] || 0) + 1;
        });

        const typeLabels = Object.keys(employeeTypeCounts);
        const typeValues = Object.values(employeeTypeCounts);

        const employeeTypeTable = document.getElementById('employee-type-table');
        employeeTypeTable.innerHTML = '';
        typeLabels.forEach((label, idx) => {
            const count = typeValues[idx];
            const percent = (count / totalOperations) * 100;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${label}</td>
                <td class="text-center">${formatNumber(count)}</td>
                <td class="text-center">${percent.toFixed(1)}%</td>
            `;
            employeeTypeTable.appendChild(tr);
        });

        // رسم بياني (نوع الموظف)
        const typeColors = [
            '#0b5d3b',
            '#c9a646',
            '#1b8a5a',
            '#f2c94c',
            '#6c757d'
        ];
        const ctxType = document.getElementById('employeeTypeChart');
        new Chart(ctxType, {
            type: 'pie',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeValues,
                    backgroundColor: typeColors.slice(0, typeLabels.length),
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { family: 'system-ui' }
                        }
                    }
                }
            }
        });

        // 3) إحصائيات حسب جهة العمل
        const employerCounts = {};
        history.forEach(r => {
            const employer = r.employerName || 'غير محدد';
            employerCounts[employer] = (employerCounts[employer] || 0) + 1;
        });

        const employerEntries = Object.entries(employerCounts)
            .sort((a, b) => b[1] - a[1])  // ترتيب تنازلي
            .slice(0, 6); // أعلى 6

        const employerLabels = employerEntries.map(e => e[0]);
        const employerValues = employerEntries.map(e => e[1]);

        const employerTable = document.getElementById('employer-table');
        employerTable.innerHTML = '';
        employerEntries.forEach(([name, count]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${name}</td>
                <td class="text-center">${formatNumber(count)}</td>
            `;
            employerTable.appendChild(tr);
        });

        const ctxEmployer = document.getElementById('employerChart');
        new Chart(ctxEmployer, {
            type: 'bar',
            data: {
                labels: employerLabels,
                datasets: [{
                    label: 'عدد العمليات',
                    data: employerValues,
                    backgroundColor: '#0b5d3b'
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // 4) جدول أحدث العمليات (آخر 10)
        const historyTable = document.getElementById('history-table');
        historyTable.innerHTML = '';

        const last10 = history
            .map((r, idx) => ({...r, _index: idx + 1}))
            .reverse()
            .slice(0, 10);

        last10.forEach((record, idx) => {
            const tr = document.createElement('tr');

            const basic = toNumber(record.basicSalary);
            const allowances = toNumber(record.allowances);
            const salary =
                toNumber(record.totalMonthlySalary) ||
                toNumber(record.monthlySalary) ||
                (basic + allowances);

            const salaryAfterInsurance = toNumber(record.salaryAfterInsurance) || salary;

            const reward =
                toNumber(record.endOfServiceReward) ||
                toNumber(record.totalReward) ||
                toNumber(record.totalBenefits);

            const years =
                toNumber(record.serviceYears) ||
                toNumber(record.yearsOfService);

            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${record.employeeName || '-'}</td>
                <td>${record.employerName || '-'}</td>
                <td>${record.employeeType || '-'}</td>
                <td>${record.contractType || '-'}</td>
                <td>${years ? formatNumber(years) : '-'}</td>
                <td>${salary ? formatCurrency(salary) : '-'}</td>
                <td>${salaryAfterInsurance ? formatCurrency(salaryAfterInsurance) : '-'}</td>
                <td>${reward ? formatCurrency(reward) : '-'}</td>
                <td>${formatDate(record.createdAt)}</td>
            `;
            historyTable.appendChild(tr);
        });
    }

    document.getElementById('btn-refresh').addEventListener('click', buildStats);

    // تحميل عند فتح الصفحة
    buildStats();
</script>

</body>
</html>